<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>数据采集</title>
  <!-- 引入 layui 样式 -->
  <link rel="stylesheet" href="//unpkg.com/layui@2.11.2/dist/css/layui.css">
        <style>
    /* 调整全局样式 */
body {
  background-color: #f5f5f5; /* 淡背景提升对比 */
  font-family: "Microsoft YaHei", Arial, sans-serif; /* 提高中文兼容性 */
}
.layui-container {
  margin-top: 30px;
}
.layui-card {
  width: 90%; /* 统一所有card宽度 */
  margin: 20px auto; /* 上下间距20px */
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 一致阴影效果 */
  background-color: #ffffff; /* 确保卡片背景为白色 */
}
.layui-card-header {
  text-align: center;
  font-size: 22px;
  font-weight: bold;
  color: #009688; /* 标题绿色 */
  margin-bottom: 10px; /* 标题与内容间距 */
}
.layui-card-body {
  padding: 20px; /* 卡片内容统一内边距 */
}
.layui-form-item {
  display: flex; /* 使用 flex 居中和对齐项目 */
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}
.layui-form-label {
  font-weight: bold; /* 标签加粗 */
  color: #777; /* 标签灰色提升对比度 */
}
.layui-input-inline {
  display: flex;
  flex-shrink: 1;
}
.layui-input {
  border-radius: 4px;
  width: 100%; /* 保证输入框在弹性布局下填充 */
}
.layui-btn {
  border-radius: 4px; /* 增加按钮圆角 */
  margin: 5px; /* 统一按钮间距 */
}
.layui-btn-primary {
  background-color: #f2f2f2 !important;
  color: #333 !important;
}
.layui-btn-normal {
  background-color: #009688 !important;
  color: white !important;
}
.layui-btn-warm {
  background-color: #FFB800 !important;
  color: white !important;
}
.layui-btn-danger {
  background-color: #FF5722 !important;
  color: white !important;
}
  </style>
</head>
<body>
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo layui-hide-xs layui-bg-black">
        <i class="layui-icon layui-icon-bot"></i>
        PRLAB-Robotics</div>

    <ul class="layui-nav layui-layout-left">
      <!-- 移动端显示 -->
      <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
        <i class="layui-icon layui-icon-spread-left"></i>
      </li>


  <li class="layui-nav-item"><a href="/" data-url="/static/pages/sampling.html">机械臂采样<i class="layui-icon layui-icon-home"></i></a></li>
      <li class="layui-nav-item"><a href="/" data-url="/static/pages/testing.html">机械臂测试<i class="layui-icon layui-icon-home"></i></a></li>
        <li class="layui-nav-item"><a href="/static/pages/data_collection.html">数据采集</a></li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item layui-hide layui-show-sm-inline-block">
        <a href="javascript:;">
          <img src="//unpkg.com/outeres@0.0.10/img/layui/icon-v2.png" class="layui-nav-img">
          Prlab
        </a>
        <dl class="layui-nav-child">
          <dd><a href="javascript:;">Lab Profile</a></dd>
          <dd><a href="javascript:;">Settings</a></dd>
          <dd><a href="javascript:;">Can't sign out</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item" lay-header-event="menuRight" lay-unselect>
        <a href="javascript:;">
          <i class="layui-icon layui-icon-more-vertical"></i>
        </a>
      </li>
    </ul>
  </div>

    <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <ul class="layui-nav layui-nav-tree" lay-filter="test">
        <li class="layui-nav-item"><a href="/"><i class="layui-icon layui-icon-home"></i> 返回主页</a></li>
        <li class="layui-nav-item"><a href="/static/pages/introduction.html"><i class="layui-icon layui-icon-read"></i> 入门文档</a></li>
        <li class="layui-nav-item"><a href="/static/pages/introduction.html"><i class="layui-icon layui-icon-template"></i> 解决方案</a></li>
      </ul>
    </div>
  </div>

    <!-- 主体内容区域 -->
  <div class="layui-body">
    <div id="page-content" style="padding: 15px;">

        <div class="layui-container" style="margin: 30px auto; text-align: center;">

    <!-- 数据采集卡片 -->
    <div class="layui-card" style="width: 80%; margin: 20px auto;">
      <div class="layui-card-header" style="text-align: center; font-size: 22px; font-weight: bold;">
        数据采集
      </div>
      <div class="layui-card-body" style="padding: 20px;">

        <!-- 输入框：文件路径 -->
<div class="layui-form-item">
  <label class="layui-form-label" style="width: 150px; text-align: right;">文件路径</label>
  <div class="layui-input-inline" style="width: 450px;">
    <input type="text" id="data_file_path" class="layui-input" placeholder="输入文件路径" value="home/arm_controller/data/collection/">
  </div>
  <!-- 添加时间戳按钮 -->
  <button type="button" class="layui-btn layui-btn-warm" id="add_timestamp_button" style="margin-left: 10px;">
    添加时间戳
  </button>
</div>

        <!-- 按钮 -->
        <div class="layui-form-item" style="margin-top: 20px;">
          <button type="button" class="layui-btn layui-btn-normal" id="start_data_collection">
            开始采集
          </button>
          <button type="button" class="layui-btn layui-btn-danger" id="stop_data_collection" disabled>
            结束采集
          </button>
        </div>
      </div>
    </div>

      <div class="layui-card">
    <div class="layui-card-header">技能管理</div>
    <div class="layui-card-body">

      <!-- 功能按钮 -->
      <div class="action-buttons">
        <button class="layui-btn layui-btn-normal" id="add_skill_button">添加技能</button>
        <button class="layui-btn" id="import_skill_button">导入技能</button>
        <button class="layui-btn layui-btn-warm" id="export_selected_button">导出技能</button>
      </div>

      <!-- 技能树状表格 -->
      <table class="layui-hide" id="skill_tree_table" lay-filter="skill_tree_table"></table>

    </div>
  </div>

  <!-- 添加子操作的弹窗（模态框） -->
  <div id="add_suboperation_modal" style="display: none;">
    <form class="layui-form" style="padding: 20px;">

      <!-- 操作种类 -->
      <div class="layui-form-item">
        <label class="layui-form-label">操作种类</label>
        <div class="layui-input-block">
          <select id="operation_type" lay-filter="operation_type">
            <option value="">请选择操作种类</option>
            <option value="pose">移动到位姿</option>
            <option value="trajectory">复现轨迹</option>
            <option value="gripper">夹爪操作</option>
          </select>
        </div>
      </div>

      <!-- 动态表格：显示对应的数据以供选择 -->
      <div class="layui-form-item" id="dynamic_table">
        <table class="layui-hide" id="operation_selection_table" lay-filter="operation_selection_table"></table>
      </div>

      <!-- 提交按钮 -->
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button type="button" class="layui-btn" id="add_operation_submit">确定添加</button>
          <button type="button" class="layui-btn layui-btn-danger" id="add_operation_cancel">取消</button>
        </div>
      </div>
    </form>
  </div>
  </div>

    </div>
  </div>

  <!-- 底部区域 -->
  <div class="layui-footer">
    <p>© 2025 PRLAB Robotics. All Rights Reserved.</p>
  </div>
</div>


  <!-- 引入 layui 和 jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="//unpkg.com/layui@2.11.2/dist/layui.js"></script>
  <script>
  layui.use(['table', 'layer', 'form', 'jquery'], function() {
  const table = layui.table;
  const layer = layui.layer;
  const form = layui.form;
  const $ = layui.$;

  // 添加一些测试数据
let allSkills = [
  {
    id: `skill_${Date.now()}`,
    name: '测试技能',
    description: '这是一个测试技能',
    timestamp: new Date().toLocaleString(),
    children: []
  }
];


  // 顶部功能按钮事件
  $('#add_skill_button').on('click', function() {
    // 添加技能逻辑
    const skillName = prompt('请输入技能名称:');
    if (skillName) {
      const newSkill = {
        id: `skill_${Date.now()}`,
        name: skillName,
        description: '',
        timestamp: (new Date()).toLocaleString(),
        children: []
      };
      allSkills.push(newSkill);
      // 重新渲染表格
      table.reload('skill_tree_id', { data: allSkills });
    }
  });

  $('#import_skill_button').on('click', function() {
    // 文件导入技能
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'application/json';
    fileInput.onchange = function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedSkill = JSON.parse(e.target.result);
          allSkills.push(importedSkill);
          table.reload('skill_tree_id', { data: allSkills });
          layer.msg('技能导入成功', { icon: 1 });
        } catch (err) {
          layer.msg('技能导入失败，请检查文件格式', { icon: 2 });
        }
      };
      reader.readAsText(file);
    };
    fileInput.click();
  });

  $('#export_selected_button').on('click', function() {
    // 导出技能逻辑（支持多选导出）
    const selectedSkills = table.checkStatus('skill_tree_id').data;
    if (selectedSkills.length === 0) {
      layer.msg('请选择要导出的技能', { icon: 0 });
      return;
    }
    const blob = new Blob([JSON.stringify(selectedSkills, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'skills.json';
    link.click();
    layer.msg('技能导出成功', { icon: 1 });
  });



  // 子操作添加模态框逻辑
  table.on('tool(skill_tree_table)', function(obj) {
      console.log('工具条事件触发', obj); // 检查 console 输出是否触发
    const { event, data } = obj;
    if (event === 'add_suboperation') {
        console.log('触发添加子操作');
      // 弹出添加子操作模态框
      layer.open({
        type: 1,
        title: '添加子操作',
        content: $('#add_suboperation_modal'),
        area: ['500px', '400px']
      });

      // 设置种类动态表格
      form.on('select(operation_type)', function(selectData) {
        const type = selectData.value;
        const tableConfig = {
          elem: '#operation_selection_table',
          data: [], // 根据类型拉取对应的后端数据
          cols: [[]]
        };

        if (type === 'pose') {
          tableConfig.cols[0] = [
            { type: 'radio' },
            { field: 'pose', title: '位姿' },
              { field: 'description', title: '描述' },
            { field: 'timestamp', title: '采集时间' }
          ];
          fetchSavedPoses(tableConfig);
        } else if (type === 'trajectory') {
          tableConfig.cols[0] = [
            { type: 'radio' },
              { field: 'path', title: '文件路径' },
            { field: 'file_name', title: '轨迹名称' },
              { field: 'description', title: '描述' },
              { field: 'timestamp', title: '采集时间' }
          ];
          fetchSavedTrajectories(tableConfig);
        } else if (type === 'gripper') {
          tableConfig.cols[0] = [
            { type: 'radio' },
            { field: 'state', title: '夹爪状态' },
              { field: 'description', title: '描述' },
              { field: 'timestamp', title: '采集时间' }
          ];
          fetchSavedGripperStates(tableConfig);
        }

        table.render(tableConfig);
      });

      $('#add_operation_submit').on('click', function() {
        // 提交添加子操作逻辑
      });
    }
  });

  function fetchSavedPoses(config) {
    $.ajax({
      url: '/get/saved_poses/',
      method: 'GET',
      success: function(data) {
        config.data = data.poses || [];
        table.render(config);
      },
      error: function() {
        layer.msg('位姿数据获取失败', { icon: 2 });
      }
    });
  }

  function fetchSavedTrajectories(config) {
    $.ajax({
      url: '/get/saved_trajectories/',
      method: 'GET',
      success: function(data) {
        config.data = data.trajectories || [];
        table.render(config);
      },
      error: function() {
        layer.msg('轨迹数据获取失败', { icon: 2 });
      }
    });
  }

  function fetchSavedGripperStates(config) {
    $.ajax({
      url: '/get/saved_gripper_states/',
      method: 'GET',
      success: function(data) {
        config.data = data.states || [];
        table.render(config);
      },
      error: function() {
        layer.msg('夹爪状态数据获取失败', { icon: 2 });
      }
    });
  }

        // 初始化技能树状表格
  table.render({
    elem: '#skill_tree_table',
    id: 'skill_tree_id',
    data: allSkills,
    toolbar: true,
    cols: [[
      { type: 'numbers', title: '序号' },
      { field: 'name', title: '技能名称', edit: 'text' },
      { field: 'description', title: '技能描述', edit: 'text' },
      { field: 'timestamp', title: '创建时间' },
      { field: 'actions', title: '操作', toolbar: '#skill_actions_bar' }
    ]]
  });

      $('#add_timestamp_button').on('click', function () {
  const filePath = $('#data_file_path').val(); // 获取当前输入的文件路径

  // 文件路径不能为空
  if (!filePath) {
    layer.msg("文件路径不能为空，无法添加时间戳！", {icon: 2});
    return;
  }

  // 获取当前时间戳
  const timestamp = new Date().toISOString().replace(/[-:.T]/g, '').slice(0, 14);

  // 在文件路径中添加时间戳
  if (filePath.endsWith('/')) {
    $('#data_file_path').val(filePath + timestamp);
  } else {
    $('#data_file_path').val(filePath + timestamp);
  }

  // 添加成功提示
  layer.msg('时间戳已添加到文件路径！', {icon: 1});
});

    // 点击“开始采集”按钮
    $('#start_data_collection').on('click', function () {
      const filePath = $('#data_file_path').val();

      // 文件路径不能为空
      if (!filePath) {
        layer.msg("文件路径不能为空！", {icon: 2});
        return;
      }

      // 模拟后端接口请求
      $.ajax({
        url: '/start_data_collection/',
        type: 'POST',
        data: { file_path: filePath },
        headers: { "X-CSRFToken": '{{ csrf_token }}' },
        success: function (data) {
          layer.msg("数据采集已开始！", {icon: 1});
          $('#start_data_collection').attr('disabled', true);  // 禁用开始按钮
          $('#stop_data_collection').removeAttr('disabled');  // 启用结束按钮
        },
        error: function (error) {
          layer.msg("数据采集失败，请重试！", {icon: 2});
        }
      });
    });

    // 点击“结束采集”按钮
    $('#stop_data_collection').on('click', function () {
      // 模拟结束采集请求
      $.ajax({
        url: '/stop_data_collection/',
        type: 'POST',
        headers: { "X-CSRFToken": '{{ csrf_token }}' },
        success: function (data) {
          layer.msg("数据采集已完成！", {icon: 1});
          $('#start_data_collection').removeAttr('disabled');  // 启用开始按钮
          $('#stop_data_collection').attr('disabled', true);   // 禁用结束按钮
        },
        error: function (error) {
          layer.msg("数据采集结束失败，请重试！", {icon: 2});
        }
      });
    });
  });
  </script>
<script type="text/html" id="skill_actions_bar">
  <a class="layui-btn layui-btn-xs" lay-event="add_suboperation">添加子操作</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除技能</a>
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="execute_skill">执行技能</a>
</script>
</body>
</html>